v {xschem version=3.1.0 file_version=1.2
}
G {}
K {}
V {}
S {}
E {}
N 690 -260 690 -250 {
lab=Vref}
N 690 -190 690 -110 {
lab=GND}
N 260 -300 430 -300 {
lab=#net1}
N 260 -240 280 -240 {
lab=GND}
N 290 20 290 40 {
lab=GND}
N 360 20 360 30 {
lab=GND}
N 290 30 360 30 {
lab=GND}
N 300 -200 370 -200 {
lab=Vreg}
N 370 -200 390 -200 {
lab=Vreg}
N -170 -150 -170 -140 {
lab=GND}
N 430 -300 480 -300 {
lab=#net1}
N -170 -200 -170 -150 {
lab=GND}
N -170 -320 -170 -260 {
lab=Vdd}
N 690 -270 690 -260 {
lab=Vref}
N 360 -80 360 -70 {
lab=#net2}
N 360 -10 360 20 {
lab=GND}
N 290 -80 290 20 {
lab=GND}
N 270 -200 300 -200 {
lab=Vreg}
N 280 -240 390 -240 {
lab=GND}
N 2030 -260 2030 -250 {
lab=Vref1}
N 2030 -190 2030 -110 {
lab=GND}
N 1470 -240 1490 -240 {
lab=GND}
N 1500 20 1500 40 {
lab=GND}
N 1570 20 1570 30 {
lab=GND}
N 1500 30 1570 30 {
lab=GND}
N 1500 -200 1570 -200 {
lab=Vreg1}
N 1570 -200 1590 -200 {
lab=Vreg1}
N 1040 -150 1040 -140 {
lab=GND}
N 1040 -200 1040 -150 {
lab=GND}
N 1040 -320 1040 -260 {
lab=Vdd1}
N 2030 -270 2030 -260 {
lab=Vref1}
N 1570 -80 1570 -70 {
lab=#net3}
N 1570 -10 1570 20 {
lab=GND}
N 1500 -80 1500 20 {
lab=GND}
N 1470 -200 1500 -200 {
lab=Vreg1}
N 1490 -240 1600 -240 {
lab=GND}
N 1570 -570 1570 -430 {
lab=probe}
N 1520 -490 1570 -490 {
lab=probe}
N 1440 -490 1460 -490 {
lab=GND}
N 1570 -640 1570 -630 {
lab=#net4}
N 1690 -360 1690 -340 {
lab=#net4}
N 290 -200 290 -180 {
lab=Vreg}
N 260 -200 270 -200 {
lab=Vreg}
N 260 -280 470 -280 {
lab=Vref}
N -170 -320 -40 -320 {
lab=Vdd}
N 1040 -320 1170 -320 {
lab=Vdd1}
N 1500 -160 1500 -140 {
lab=Vreg1}
N 2030 -280 2030 -270 {
lab=Vref1}
N 1470 -320 1690 -320 {
lab=#net4}
N 1690 -340 1690 -320 {
lab=#net4}
N 260 -320 480 -320 {
lab=Vreg}
N 1570 -640 1580 -640 {
lab=#net4}
N 1690 -640 1690 -360 {
lab=#net4}
N 1590 -640 1610 -640 {
lab=#net4}
N 1580 -640 1590 -640 {
lab=#net4}
N 360 -200 360 -180 {
lab=Vreg}
N 1500 -200 1500 -180 {
lab=Vreg1}
N 290 -180 290 -140 {
lab=Vreg}
N 360 -180 360 -140 {
lab=Vreg}
N 470 -280 690 -280 {
lab=Vref}
N 690 -280 690 -270 {
lab=Vref}
N 550 -190 550 -110 {
lab=GND}
N 360 -420 360 -200 {
lab=Vreg}
N 480 -230 480 -220 {
lab=#net5}
N 480 -160 480 -80 {
lab=GND}
N 480 -240 480 -230 {
lab=#net5}
N 1500 -180 1500 -160 {
lab=Vreg1}
N 1570 -370 1570 -140 {
lab=Vreg1}
N 1780 -260 1780 -250 {
lab=#net6}
N 1780 -190 1780 -110 {
lab=GND}
N 1710 -230 1710 -220 {
lab=#net7}
N 1710 -160 1710 -80 {
lab=GND}
N 1710 -240 1710 -230 {
lab=#net7}
N 1470 -280 2030 -280 {
lab=Vref1}
N 260 -220 260 -200 {
lab=Vreg}
N 480 -260 480 -240 {
lab=#net5}
N 260 -260 480 -260 {
lab=#net5}
N 480 -300 550 -300 {
lab=#net1}
N 550 -300 550 -250 {
lab=#net1}
N 1470 -300 1780 -300 {
lab=#net6}
N 1780 -300 1780 -260 {
lab=#net6}
N 1470 -260 1710 -260 {
lab=#net7}
N 1710 -260 1710 -240 {
lab=#net7}
N 1470 -220 1470 -200 {
lab=Vreg1}
N 360 -420 480 -420 {
lab=Vreg}
N 480 -420 480 -320 {
lab=Vreg}
N 1610 -640 1690 -640 {
lab=#net4}
C {devices/gnd.sym} 690 -110 0 0 {name=l1 lab=GND}
C {devices/vsource.sym} 690 -220 0 0 {name=Vref value=Vref}
C {devices/gnd.sym} 390 -240 3 0 {name=l4 lab=GND}
C {devices/gnd.sym} 290 40 0 0 {name=l5 lab=GND}
C {devices/isource.sym} 360 -110 0 0 {name=IL value="dc IL PULSE(10u IL 0 10n 10n 50u 100u 0)"}
C {devices/opin.sym} 390 -200 0 0 {name=p7 lab=Vreg}
C {devices/gnd.sym} -170 -140 0 0 {name=l7 lab=GND}
C {devices/vsource.sym} -170 -230 0 0 {name=Vdd value="ac 1 dc Vdd"}
C {devices/lab_pin.sym} -170 -320 0 0 {name=p8 sig_type=std_logic lab=Vdd}
C {devices/lab_pin.sym} 690 -270 2 0 {name=p9 sig_type=std_logic lab=Vref}
C {sky130_fd_pr/cap_mim_m3_1.sym} 290 -110 0 0 {name=CL model=cap_mim_m3_1 W=30 L=30 MF=M_CL spiceprefix=X}
C {devices/res.sym} 360 -40 0 0 {name=Rdummy
value=1
footprint=1206
device=resistor
m=1}
C {ldo_folded_cascode.sym} 110 -270 0 0 {name=x1}
C {devices/code_shown.sym} -190 90 0 0 {name=s2 only_toplevel=false value=".include /autofs/fs1.ece/fs1.eecg.tcc/lizongh2/sky130_ldo/xschem/simulations/ldo_folded_cascode_tb_vars.spice
"}
C {devices/code_shown.sym} -200 250 0 0 {name=s4 only_toplevel=false 
value="
.nodeset v(Vreg)=1.8
.nodeset v(Vreg1)=1.8

.control
* high precision simulation
*.OPTIONS maxord=1
.OPTIONS itl1=200
.OPTIONS itl2=200
.OPTIONS itl4=200

* save all voltage and current
save all 
.options savecurrents
set filetype=ascii
set units=degrees

* Loop stability
alter IL1 dc=10u
let runs=2
let run=0

alter @Vprobe1[acmag]=1
alter @Iprobe1[acmag]=0

dowhile run<runs
set run="$&run"
set temp=27

ac dec 10 1 10G

alter @Vprobe1[acmag]=0
alter @Iprobe1[acmag]=1

let run=run+1
end

let ip11 = ac1.i(Vprobe1)
let ip12 = ac1.i(Vprobe2)
let ip21 = ac2.i(Vprobe1)
let ip22 = ac2.i(Vprobe2)
let vprb1 = ac1.v(probe)
let vprb2 = ac2.v(probe)

*** Middlebrook
let mb = 1/(vprb1+ip22)-1 
*** Tian that is preferred
let av = 1/(1/(2*(ip11*vprb2-vprb1*ip21)+vprb1+ip21)-1) 

plot vdb(mb) vp(mb)
plot vdb(av) vp(av)

wrdata ldo_folded_cascode_tb_loop_gain_minload mag(av) vp(av)

* at max load
reset all
alter IL1 dc=10m
let runs=2
let run=0

alter @Vprobe1[acmag]=1
alter @Iprobe1[acmag]=0

dowhile run<runs
set run="$&run"
set temp=27

ac dec 10 1 10G

alter @Vprobe1[acmag]=0
alter @Iprobe1[acmag]=1

let run=run+1
end

let ip11 = ac3.i(Vprobe1)
let ip12 = ac3.i(Vprobe2)
let ip21 = ac4.i(Vprobe1)
let ip22 = ac4.i(Vprobe2)
let vprb1 = ac3.v(probe)
let vprb2 = ac4.v(probe)

*** Middlebrook
let mb = 1/(vprb1+ip22)-1 
*** Tian that is preferred
let av = 1/(1/(2*(ip11*vprb2-vprb1*ip21)+vprb1+ip21)-1) 

plot vdb(mb) vp(mb)
plot vdb(av) vp(av)

wrdata ldo_folded_cascode_tb_loop_gain_maxload mag(av) vp(av)

* DC sweep
dc Vdd 1 3 0.01
plot v(Vdd) v(Vreg)
wrdata ldo_folded_cascode_tb_dc v(Vreg)

* Transient analysis with load regulation
* do not miss the space between the square bracket and number
tran 10n 100u
plot @Rdummy[i]
plot Vreg
wrdata ldo_folded_cascode_tb_load_reg Vreg

* Transient analysis with line regulation
* at minimum load current 10uA
*alter @IL[PULSE] [ 10u 10u 0 10n 10n 100u 100u 0 ]
*alter @Vdd[PULSE] [ 2 2.5 0 1u 1u 25u 50u 0 ]
*tran 10n 100u
*plot Vdd
*plot @Rdummy[i]
*plot Vreg
*wrdata ldo_folded_cascode_tb_line_reg_minload Vreg

* at maximum load current 10mA
*alter @IL[PULSE] [ 10m 10m 0 10n 10n 100u 100u 0 ]
*tran 10n 100u
*plot @Rdummy[i]
*plot Vreg
*wrdata ldo_folded_cascode_tb_line_reg_maxload Vreg


* PSRR with max load
alter Vdd ac=1
alter Vprobe1 ac=0
ac dec 10 1 10G
plot vdb(Vreg)
wrdata ldo_folded_cascode_tb_psrr_maxload mag(Vreg) vp(Vreg)

* PSRR with min load
alter IL dc=10u
ac dec 10 1 10G
plot vdb(Vreg)
wrdata ldo_folded_cascode_tb_psrr_minload mag(Vreg) vp(Vreg)
*min load do a pz analysis
pz Vdd GND Vreg GND vol pz
print pole(1) pole(2) pole(3) pole(4) pole(5) pole(6) pole(7) pole(8) pole(9)
print zero(1) zero(2) zero(3) zero(4) zero(5) zero(6) zero(7) zero(8) zero(9)

* OP
op
alter IL dc=10u 
.include /autofs/fs1.ece/fs1.eecg.tcc/lizongh2/sky130_ldo/python/ldo/simulations/ldo_folded_cascode_tb_dev_params.spice
.endc
"}
C {devices/gnd.sym} 2030 -110 0 0 {name=l8 lab=GND}
C {devices/vsource.sym} 2030 -220 0 0 {name=Vref1 value=Vref}
C {devices/gnd.sym} 1600 -240 3 0 {name=l10 lab=GND}
C {devices/gnd.sym} 1500 40 0 0 {name=l11 lab=GND}
C {devices/isource.sym} 1570 -110 0 0 {name=IL1 value="dc IL PULSE(10u IL 0 10n 10n 50u 100u 0)"}
C {devices/opin.sym} 1590 -200 0 0 {name=p1 lab=Vreg1}
C {devices/gnd.sym} 1040 -140 0 0 {name=l12 lab=GND}
C {devices/vsource.sym} 1040 -230 0 0 {name=Vdd2 value="Vdd"}
C {devices/lab_pin.sym} 1040 -320 0 0 {name=p2 sig_type=std_logic lab=Vdd1}
C {devices/lab_pin.sym} 2030 -270 2 0 {name=p3 sig_type=std_logic lab=Vref1}
C {sky130_fd_pr/cap_mim_m3_1.sym} 1500 -110 0 0 {name=CL1 model=cap_mim_m3_1 W=30 L=30 MF=M_CL spiceprefix=X}
C {devices/res.sym} 1570 -40 0 0 {name=Rdummy1
value=1
footprint=1206
device=resistor
m=1}
C {ldo_folded_cascode.sym} 1320 -270 0 0 {name=x2}
C {devices/vsource.sym} 1570 -600 2 0 {name=Vprobe2 value="dc 0"}
C {devices/vsource.sym} 1570 -400 0 0 {name=Vprobe1 value="dc 0 ac 1"}
C {devices/isource.sym} 1490 -490 3 0 {name=Iprobe1 value="dc 0 ac 0"}
C {devices/gnd.sym} 1440 -490 1 0 {name=l15 lab=GND}
C {devices/lab_pin.sym} 1570 -510 2 0 {name=p4 sig_type=std_logic lab=probe}
C {sky130_fd_pr/corner.sym} -390 -430 0 0 {name=CORNER only_toplevel=false corner=tt}
C {devices/gnd.sym} 550 -110 0 0 {name=l6 lab=GND}
C {devices/vsource.sym} 550 -220 0 0 {name=Vb2 value=Vb2}
C {devices/gnd.sym} 480 -80 0 0 {name=l13 lab=GND}
C {devices/vsource.sym} 480 -190 0 0 {name=Vb1 value=Vb1}
C {devices/gnd.sym} 1780 -110 0 0 {name=l16 lab=GND}
C {devices/vsource.sym} 1780 -220 0 0 {name=Vb4 value=Vb2}
C {devices/gnd.sym} 1710 -80 0 0 {name=l17 lab=GND}
C {devices/vsource.sym} 1710 -190 0 0 {name=Vb3 value=Vb1}
